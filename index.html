<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>cryptoGlance :: micro-pi Edition!</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="shortcut icon" href="favicon.png">

        <link rel="stylesheet" href="css/cryptoglance-base.css">
        <link rel="stylesheet" href="css/whhg.css">
    </head>
    <body>
        <header>cryptoGlance :: micro-pi Edition!</header>

        <div id="tabs">
            <div class="tab main">
                <h1 class="bitcoin"><small>CDN</small> <span>0</span> <i class="icon icon-timer"></i></h1>
                <section class="btc-meta">
                </section>
                <footer class="bitcoin">
                    <p>last updated &nbsp;<span class="yellow"></span></p>
                </footer>

                <h1 class="reddcoin"><span>0</span> <small>satoshi</small> <i class="icon icon-timer"></i></h1>
                <section class="rdd-meta">
                </section>
                <footer class="reddcoin">
                    <p>last updated &nbsp;<span class="yellow"></span></p>
                </footer>
            </div>

            <div class="tab details">
                <div id="bitcoin-bg"></div>
                <div class="stat-pair blue" id="details-last">
                    <p>0</p>
                    <h4>last</h4>
                </div>

                <div class="stat-pair" id="details-volume">
                    <p>0</p>
                    <h4>volume</h4>
                </div>

                <div class="stat-pair green" id="details-high">
                    <p>0</p>
                    <h4>high</h4>
                </div>

                <div class="stat-pair red" id="details-low">
                    <p>0</p>
                    <h4>low</h4>
                </div>

                <div class="stat-pair orange" id="details-ask">
                    <p>0</p>
                    <h4>ask</h4>
                </div>

                <div class="stat-pair yellow" id="details-bid">
                    <p>0</p>
                    <h4>bid</h4>
                </div>
            </div>

            <div class="tab balances">
                <h1 class="balance"><span class="green">0 bitcoins :'(</span> <small>BTC</small></h1>
                <p>Total Received:</p>
                <h2><span id="totalreceived"></span> <small>BTC</small></h2>
                <p>Total Spent:</p>
                <h2><span id="totalspent" class="red"></span> <small>BTC</small></h2>
            </div>

            <div class="tab charts">
                <img src="https://bitcoinity.org/markets/image?span=7d&size=medium&currency=CAD&exchange=cavirtex" alt="bitcoin price chart"/>
            </div>
        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.2.min.js"><\/script>')</script>
        <script src="js/moment.min.js"></script>

        <script type="text/javascript">
            function externalLinks() {
              if (!document.getElementsByTagName) return;
              var anchors = document.getElementsByTagName("a");
              for (var i=0; i<anchors.length; i++) {
                var anchor = anchors[i];
                if (anchor.getAttribute("href") &&
                  anchor.getAttribute("rel") == "external")
                  anchor.target = "_blank";
              }
            }

            function updateBTCbalance() {

                $.getJSON("json-blockr.php").done(function() {
                }, function(jsonBTCbalance) {

                    console.log(jsonBTCbalance);

                    var sum = 0,
                        cleanSum = 0,
                        addressData = jsonBTCbalance.data,
                        totalInputs = 0,
                        totalSpent = 0,
                        i;
                    for (i = 0; i < addressData.length; i++) {  //loop through the array
                        sum += addressData[i].balance;  //Do the math!
                        totalInputs += addressData[i].totalreceived;  //Do the math!
                    }

                    sum /= Math.max(10, 8)/10;
                    sum = sum.toFixed(8);
                    totalInputs /= Math.max(10, 8)/10;
                    totalInputs = totalInputs.toFixed(8);
                    totalSpent = totalInputs - sum;

                    $(".balances h1 span").html(sum);
                    $(".balances h2 span").html(totalInputs);
                    $(".balances h2:nth-of-type(2) span").html(totalSpent);
                });
            }


            function updateBTC() {

                window.compareBTCPrice = $("h1.bitcoin span").html();

                $.getJSON("json-quadriga_cx.php").done(function() {
                }, function(jsonBTC) {

                    console.log(jsonBTC);

                    window.lastBTCtrade = jsonBTC.last;

                    $("h1.bitcoin span").html(lastBTCtrade);

                    var quadrigaTime = moment.unix(jsonBTC.timestamp).format("h:mm:ss a");
                    $("footer.bitcoin span").html(quadrigaTime);

                    console.log("lastBTCtrade == " + window.lastBTCtrade);
                    console.log("compareBTCPrice == " + window.compareBTCPrice);

                    if (window.lastBTCtrade > window.compareBTCPrice) {
                        $("h1.bitcoin i").removeClass().addClass("icon icon-chevron-up green");
                        $("h1.bitcoin span").removeClass().addClass("green");
                    } else if (window.lastBTCtrade == window.compareBTCPrice) {
                        $("h1.bitcoin i").removeClass().addClass("icon icon-minus yellow");
                        $("h1.bitcoin span").removeClass().addClass("yellow");
                    } else {
                        $("h1.bitcoin i").removeClass().addClass("icon icon-chevron-down red");
                        $("h1.bitcoin span").removeClass().addClass("red");
                    }

                    var trimVolume = jsonBTC.volume;

                    // build details screen
                    $("#details-last p").html(jsonBTC.last);
                    $("#details-volume p").html(trimVolume.slice(0,-6));
                    $("#details-high p").html(jsonBTC.high);
                    $("#details-low p").html(jsonBTC.low);
                    $("#details-ask p").html(jsonBTC.ask);
                    $("#details-bid p").html(jsonBTC.bid);

                });
            }

            function updateRDD() {

                // TODO: There's a bug in the calculation here, try all cases to see (thinks 4 > 10 for e.g.)

                window.compareRDDPrice = $("h1.reddcoin span").html();

                $.getJSON("json-cryptsy.php").done(function() {
                }, function(jsonRDD) {

                    console.log(jsonRDD);

                    window.lastRDDtrade = jsonRDD.return.markets.RDD.lasttradeprice;
                    window.lastRDDtrade /= Math.pow(10, -8);
                    window.lastRDDtrade = window.lastRDDtrade.toFixed(0);

                    $("h1.reddcoin span").html(lastRDDtrade);

                    var cryptsyTime = moment(jsonRDD.return.markets.RDD.lasttradetime).format("h:mm:ss a");
                    $("footer.reddcoin span").html(cryptsyTime);

                    console.log("lastRDDtrade == " + window.lastRDDtrade);
                    console.log("compareRDDrice == " + window.compareRDDPrice);

                    if (window.lastRDDtrade > window.compareRDDPrice) {
                        $("h1.reddcoin i").removeClass().addClass("icon icon-chevron-up green");
                        $("h1.reddcoin span").removeClass().addClass("green");
                    } else if (window.lastRDDtrade == window.compareRDDPrice) {
                        $("h1.reddcoin i").removeClass().addClass("icon icon-minus yellow");
                        $("h1.reddcoin span").removeClass().addClass("yellow");
                    } else {
                        $("h1.reddcoin i").removeClass().addClass("icon icon-chevron-down red");
                        $("h1.reddcoin span").removeClass().addClass("red");
                    }
                });
            }

            function apiUpdate() {
                updateBTC();
                updateRDD();
                updateBTCbalance();
            }

            function cycleTabs() {
                $("#tabs .tab:visible").fadeToggle( function() {
                    if ($(this).next(".tab").length) {
                        $(this).next(".tab").fadeToggle();
                    } else {
                        $("#tabs .tab:first").fadeToggle();
                    }
                });
            }

            $(document).ready(function() {
                externalLinks();
                apiUpdate();

                // set for a 10m delay on API updates
                var apiInterval = self.setInterval(function(){apiUpdate()},600000);

                // set for a 30s delay on switching screens of info
                var screenSwitchInterval = self.setInterval(function(){
                    cycleTabs();
                },10000);

                // bind keys and clicks to switch screens manually
                $("body").click(function() {
                    cycleTabs();
                // clear the screenSwitchInterval so the info doesn't switch quickly in certain instances
                    clearInterval(screenSwitchInterval);
                // now that it's cleared, get'er goin' again!
                    screenSwitchInterval = self.setInterval(function(){
                        cycleTabs();
                    },10000);
                });

                $(document).keydown(function(e) {
                    switch(e.which) {
                        case 83: // "s" key
                        cycleTabs();
                        // clear the screenSwitchInterval so the info doesn't switch quickly in certain instances
                        clearInterval(screenSwitchInterval);
                        // now that it's cleared, get'er goin' again!
                        screenSwitchInterval = self.setInterval(function(){
                            cycleTabs();
                        },10000);

                        break;

                        default: return; // exit this handler for other keys
                    }
                    e.preventDefault(); // prevent the default action
                });
            });
        </script>
    </body>
</html>
